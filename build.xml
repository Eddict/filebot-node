<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<project name="filebot-node" default="package">
    <!-- include default inputs (optional) -->
    <property file="profile.properties" />

    <!-- include application properties -->
    <property name="title" value="FileBot Node" />
    <property name="version" value="0.1" />

    <tstamp>
        <format property="today" pattern="yyyy-MM-dd" />
    </tstamp>

    <!-- define source dirs -->
    <property name="dir.client" location="${basedir}/client-extjs" />
    <property name="dir.server" location="${basedir}/server-nodejs" />
    <property name="dir.package" location="${basedir}/package" />
    <property name="dir.dist" location="${basedir}/dist" />
    <property name="dir.lib" location="${basedir}/lib" />


    <target name="build">
        <!-- run sencha app build -->
        <exec executable="sencha" dir="${dir.client}">
            <arg line="app build production"/>
        </exec>

        <copy todir="${dir.dist}/generic/client">
            <fileset dir="${dir.client}/build/production/FileBot">
                <include name="**/*.html" />
                <include name="**/*.css" />
                <include name="**/*.js" />
                <include name="**/*.json" />
                <include name="**/*.png" />
                <include name="**/*.gif" />
                <include name="**/*.svg" />
            </fileset>
        </copy>

        <copy todir="${dir.dist}/generic/server">
            <fileset dir="${dir.server}">
                <include name="**/*.js" />
                <include name="**/*.json" />
                <include name="**/*.sh" />
                <exclude name="**/test/**" />
            </fileset>
        </copy>
    </target>


    <target name="spk" description="Synology NAS package">
        <taskdef name="spk" classname="net.filebot.ant.spk.SpkTask" classpath="${dir.lib}/ant-spk.jar" />

        <spk destdir="${dir.dist}" name="filebot-node" version="${version}" arch="noarch">
            <info name="displayname" value="FileBot Node Service" />
            <info name="description" value="FileBot Node allows you to execute filebot calls via Synology DSM." />
            <info name="maintainer" value="rednoah" />
            <info name="distributor" value="FileBot" />
            <info name="distributor_url" value="http://www.filebot.net/" />
            <info name="support_url" value="https://github.com/filebot/filebot-node/issues" />
            <info name="helpurl" value="https://www.filebot.net/forums/viewforum.php?f=13" />
            <info name="firmware" value="5.0" />
            <info name="startable" value="yes" />
            <info name="silent_install" value="no" />
            <info name="silent_upgrade" value="yes" />
            <info name="silent_uninstall" value="yes" />
            <info name="dsmappname" value="net.filebot.NodeClient" />
            <info name="dsmuidir" value="client" />

            <icon size="72" file="${dir.package}/synology/package/client/images/icon72.png" />
            <icon size="256" file="${dir.package}/synology/package/client/images/icon256.png" />
            
            <!-- override generic server/start.sh with synology-specific configuration -->
            <package dir="${dir.dist}/generic" />
            <package dir="${dir.package}/synology/package" includes="client/**" />
            <package dir="${dir.package}/synology/package" includes="server/*.sh" filemode="755" />
            <scripts dir="${dir.package}/synology/scripts" filemode="755" />
        </spk>
    </target>

    <target name="package" depends="clean, build, spk">

    </target>


    <target name="clean">
        <delete includeEmptyDirs="true" failonerror="false">
            <fileset defaultexcludes="false" dir="${dir.dist}" />
            <fileset defaultexcludes="false" dir="${dir.dist}" />
            <fileset defaultexcludes="false" dir="${dir.server}/log" />
            <fileset defaultexcludes="false" dir="${dir.server}" includes="*.log" />
        </delete>
    </target>


</project>
